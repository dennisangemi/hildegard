#!/bin/bash

# TODO
# verificare la corretta esecuzione del suggeritore e di qualsiasi altro comando: gestire errori

# esporta le variabili d'ambiente
set -a
#set -x

# import variables
source <(grep = scripts/config.ini)

# importing functions
source ./scripts/functions/get_anagrafica
source ./scripts/functions/get_next_mass_date
source ./scripts/functions/get_liturgia
source ./scripts/functions/convert_iso_to_extended_date
source ./scripts/functions/convert_iso_to_weekday
source ./scripts/functions/add_element_to_mkdocs_nav
source ./scripts/functions/build_hai_suggestions_blog_post

# crea cartella data se non esiste
if [ ! -d "$PATH_DATA" ]; then
  mkdir $PATH_DATA
  echo "‚úÖ Creata cartella data"
fi

# crea cartella liturgie se non esiste
if [ ! -d "$PATH_LITURGIE" ]; then
  mkdir $PATH_LITURGIE
  echo "‚úÖ Creata cartella liturgie"
fi

# rendi eseguibili gli script
chmod +x ./scripts/*

# se vuoi scaricare anagrafica canti e testi canti devi usare
# db_downloader
# con le opportune istruzioni e autenticazioni
# viene eseguito da una GitHub Action una volta al mese

# genero la data di oggi in formato iso
today=$(date +%Y-%m-%d)

# scarica liturgia
liturgia_data_iso=$(get_next_mass_date "$PATH_CALENDARIO_LITURGICO" "$today" 1)
liturgia_data_yyyymmdd=$(date -d $liturgia_data_iso +%Y%m%d)
liturgia_data_estesa=$(convert_iso_to_extended_date "$liturgia_data_iso")
liturgia_weekday=$(convert_iso_to_weekday "$liturgia_data_iso")

get_liturgia "$liturgia_data_iso" "$PATH_CALENDARIO_LITURGICO" "$PATH_LITURGIE_FORMATTED" > $PATH_LITURGIA

# se get liturgia ritorna errore, esci
if [ $? -eq 1 ]; then
  echo "‚ùå $0: Errore durante il recupero della liturgia" >&2
  exit 1
fi

echo "üìÖ Data della prossima liturgia domenicale: $(date -d $liturgia_data_iso +%d/%m/%Y)"
echo "‚úÖ Individuata liturgia"

# aggiorna canti manually selected
./scripts/get_manually_selected

# per supportare la generazione di pi√π suggerimenti bisogner√† modificare il suggeritore.py e build_page

# run suggeritore
./scripts/suggeritore.py "$liturgia_data_iso" 

# build website homepage
./scripts/build_page
echo "‚úÖ Homepage pronta"

# organize files 
cp $PATH_DATA/$FILE_BASENAME_SUGGERIMENTI-latest.csv $PATH_DATA/$FILE_BASENAME_SUGGERIMENTI-$liturgia_data_yyyymmdd.csv

suggerimenti_on_archive_path="docs/archivio/$liturgia_data_estesa.md"
cp $PATH_HOMEPAGE "$suggerimenti_on_archive_path"

# clean suggerimenti on archive
line_end=$(cat "$suggerimenti_on_archive_path" | grep -n ":material-music" | cut -d: -f1)

# delete from line 1 to line line_end
tail -n +$line_end "$suggerimenti_on_archive_path" > tmp.md
mv tmp.md "$suggerimenti_on_archive_path"

# new nav management: aggiungi la liturgia all'archivio
add_element_to_mkdocs_nav "mkdocs.yml" "$(date -d $liturgia_data_iso +%Y)" "archivio/$liturgia_data_estesa.md"
echo "üìÇ Archivio aggiornato"

# generate blog post

# to do
# substitute hardoded files with variables (per ora va bene cos√¨)

# build blog post filename
path_file_blog_post="$PATH_DIR_BLOG_POST/$BASENAME_FILE_BLOG_POST-$liturgia_data_yyyymmdd-testingv2.md"

# genera il blog post solo se il file non esite
if [ ! -f "$path_file_blog_post" ]; then
  echo "üìù Generazione del blog post..."
  echo $LLM_MODEL_DEFAULT

  build_hai_suggestions_blog_post $liturgia_data_iso \
  $PATH_CALENDARIO_LITURGICO \
  $PATH_LITURGIE \
  $PATH_DATA_TOP20 $PATH_DATA_INGRESSO $PATH_DATA_OFFERTORIO $PATH_DATA_COMUNIONE $PATH_DATA_CONGEDO \
  $PATH_TEMPLATE_BLOG_POST \
  $PATH_CANTI \
  $PATH_DATA/$FILE_BASENAME_SUGGERIMENTI-$liturgia_data_yyyymmdd.csv \
  40 \
  temp_hai_attachment_$liturgia_data_yyyymmdd.md \
  $LLM_MODEL_DEFAULT $LLM_TEMPERATURE_DEFAULT \
  $PATH_FILE_SYSTEM_PROMPT_HAI_SUGGESTIONS > $path_file_blog_post || \
  {
    echo "‚ùå Errore durante la generazione del blog post" >&2
    exit 1
  }

  echo "‚úÖ Blog post dei suggerimenti pronto"
else
  echo "‚ùå Il file $path_file_blog_post esiste gi√†. Non verr√† sovrascritto."
  exit 1
fi

echo "‚úÖ Script completato con successo"
